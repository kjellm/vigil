#! /usr/bin/env ruby

require 'celluloid/autostart'
require 'dcell'
require 'erb'
require 'reel'
require 'vigil'

DCell.start :id => "vigil_web_server", :addr => "tcp://127.0.0.1:1235"

class Inbox
  include Celluloid
  include Celluloid::Notifications
  include Celluloid::Logger

  def notify(project, task, status)
    info "Inbox: '#{project}' '#{task}' '#{status}'"
    publish 'message_received', project, task, status
  end
end

class WebsocketHandler
  include Celluloid
  include Celluloid::Notifications
  include Celluloid::Logger

  def initialize(websocket)
    @socket = websocket
    subscribe('message_received', :message_received)
  end

  def message_received(topic, project, task, status)
    info "#{self}: #{topic}, #{project}, #{task}, #{status}"
    @socket << "#{project}.#{task}.#{status}"
  rescue Reel::SocketError
    info "Time client disconnected"
    terminate
  end
end

class WebServer < Reel::Server
  include Celluloid::Logger

  def initialize(host = "0.0.0.0", port = 1236)
    info "Web server starting on #{host}:#{port}"
    @vigil = Vigil.new
    super(host, port, &method(:on_connection))
  end

  def on_connection(connection)
    while request = connection.request
      case request
      when Reel::Request
        route_request connection, request
      when Reel::WebSocket
        info "Received a WebSocket connection"
        route_websocket request
      end
    end
  end

  def route_request(connection, request)
    info "URL: #{request.url}"
    case request.url
    when "/"
      return render_index(connection)
    when /\/project\/.*/
      parts = request.url.split('/')
      return render_project(parts[2], connection)
    when /\/(static\/.*)/
      return static(connection, request, $1)
    when /coverage\/([^\/]*)\/?(.*)?/
      if $1 == $2
        return static(connection, request, File.join(@vigil.latest_revision($1).working_dir, 'coverage/index.html'))
      else
        return static(connection, request, File.join(@vigil.latest_revision($1).working_dir, 'coverage', $2))
      end
    end
    info "HERE"
    not_found(connection, request.path)
  end

  def static(connection, request, file)
    return not_found(connection, file) unless File.exists?(file)
    info "200 OK: #{request.url}"
    html = File.read(file)
    return connection.respond :ok, html
  end

  def not_found(connection, path)
    info "404 Not Found: #{path}"
    connection.respond :not_found, "Not found"
  end

  def route_websocket(socket)
    if socket.url == "/messages"
      WebsocketHandler.new(socket)
    else
      info "Received invalid WebSocket request for: #{socket.url}"
      socket.close
    end
  end

  def render_index(connection)
    info "200 OK: /"
    projects = @config.opts["projects"].keys
    html = ERB.new(File.read("html/list.html.erb")).result(binding)
    connection.respond :ok, html
  end

  def render_project(name, connection)
    project = @vigil.project(name)
    unless project
      info "404 Not Found: FIXME"
      return connection.respond :not_found, "Not found"
    end
    info "200 OK: /project/#{name}"
    html = ERB.new(File.read("html/project.html.erb")).result(binding)
    connection.respond :ok, html
  end
end

Inbox.supervise_as :inbox
WebServer.supervise_as :reel
sleep
